<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>像素画布 / Pixel Canvas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #222; color: #fff; font-family: Arial, "PingFang SC", "Microsoft YaHei", "Malgun Gothic", "Apple SD Gothic Neo", "Nanum Gothic", sans-serif; margin: 0; padding: 0; }
    .container { max-width: 400px; margin: 40px auto; background: #333; border-radius: 16px; box-shadow: 0 4px 24px #0005; padding: 24px 16px; position: relative; display: flex; flex-direction: column; align-items: center; }
    h2 { text-align: center; margin-bottom: 18px; }
    .controls-wrapper { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 12px; margin-bottom: 20px; }
    #pixelCanvas { display: block; margin-bottom: 20px; background: #111; border-radius: 8px; }
    #originalCanvas { display: block; background: #111; border-radius: 8px; cursor: move; touch-action: none; }
    .upload-btns { display: flex; justify-content: center; gap: 16px; }
    .upload-btns label { background: #b85c5c; color: #fff; border-radius: 6px; padding: 8px 18px; cursor: pointer; text-align: center; }
    .upload-btns input { display: none; }
    .tip { text-align: center; color: #aaa; font-size: 0.98em; margin-top: 10px; min-height: 1.2em; }
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    #pixelControlsRow label, #pixelControlsRow select, #pixelControlsRow input[type=range], #pixelControlsRow span {
      margin-right: 6px;
      margin-bottom: 2px;
      font-size: 1em;
    }
    #pixelControlsRow label {
      min-width: 60px;
      text-align: right;
    }
    #pixelControlsRow input[type=range] {
      width: 90px;
    }
    #pixelControlsRow select {
      min-width: 80px;
    }
    #pixelControlsRow span {
      min-width: 36px;
      display: inline-block;
      text-align: center;
    }
    .video-controls { text-align: center; margin-top: 10px; }
    .video-controls button { background: #b85c5c; color: #fff; border: none; border-radius: 6px; padding: 6px 18px; font-size: 1em; margin: 0 6px; }
    .lang-select {
      position: absolute; top: 18px; right: 18px;
      background: #b85c5c; color: #fff; border: none; border-radius: 6px;
      padding: 6px 14px; font-size: 1em; cursor: pointer; z-index: 10;
    }
    video { display: none; }
    .error { color: #ffb3b3; text-align: center; margin: 8px 0; }
    
    /* Modal styles */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 100; }
    .modal { background: #444; padding: 25px; border-radius: 12px; text-align: center; }
    .modal h3 { margin-top: 0; }
    .modal input { padding: 8px; border-radius: 6px; border: 1px solid #666; background: #555; color: #fff; text-align: center; font-size: 1.2em; margin: 10px 0; }
    .modal button { margin: 5px; }
    #room-info { margin-top: 15px; }
    #room-code-display { font-size: 2em; font-weight: bold; color: #b85c5c; letter-spacing: 4px; }
    #collab-status { position: absolute; top: 50px; right: 18px; font-size: 0.9em; color: #ccc; }

  </style>
</head>
<body>
  <div class="container">
    <select class="lang-select" id="langSelect">
      <option value="zh">中文</option>
      <option value="en">English</option>
      <option value="no">Norsk</option>
      <option value="ko">한국어</option>
    </select>
    <div id="collab-status"></div>
    <h2 id="title"></h2>
    <div class="controls-wrapper">
      <div class="upload-btns">
        <label id="imgLabel">
          <input type="file" accept="image/*" id="imgInput">
        </label>
        <label id="videoLabel">
          <input type="file" accept="video/*,.mp4,.webm,.ogg" id="videoInput">
        </label>
      </div>
       <button id="inviteBtn" style="display: none;"></button>
      <div id="mediaControls" style="display: none;">
        <div class="controls-row">
          <label id="scaleLabel"></label>
          <input type="range" id="scaleSlider" min="0.2" max="3" step="0.01" value="1">
          <span id="scaleVal">1.00</span>
        </div>
      </div>
      <div class="controls-row">
        <label id="gridLabel"></label>
        <select id="gridSizeSelect">
            <option value="8">8x8</option>
            <option value="16">16x16</option>
            <option value="32">32x32</option>
            <option value="64">64x64</option>
        </select>
      </div>
      <div class="controls-row" id="pixelControlsRow">
        <label id="shapeLabel"></label>
        <select id="shapeSelect"></select>
        <label id="radiusLabel"></label>
        <input type="range" id="radiusSlider" min="0" max="40" step="1" value="13">
        <span id="radiusVal">13</span>
        <label id="pixelSizeLabel"></label>
        <input type="range" id="pixelSizeSlider" min="0.5" max="1" step="0.01" value="1">
        <span id="pixelSizeVal">1.00</span>
      </div>
    </div>
    
    <canvas id="pixelCanvas" width="320" height="320"></canvas>
    
    <div id="originalCanvasWrapper" style="display: none;">
      <h2 id="originalTitle"></h2>
      <canvas id="originalCanvas" width="320" height="320"></canvas>
      <div class="video-controls" id="videoControls" style="display:none;">
        <button id="playBtn"></button>
        <button id="pauseBtn"></button>
      </div>
    </div>

    <video id="video" crossorigin="anonymous" playsinline webkit-playsinline loop autoplay></video>
    <div class="error" id="errorMsg"></div>
    <div class="tip" id="tip"></div>
  </div>

  <div class="modal-overlay" id="collabModal">
    <div class="modal">
      <h3 id="modalTitle"></h3>
      <div id="create-room-view">
        <button id="createRoomBtn"></button>
      </div>
      <div id="join-room-view" style="display:none;">
         <input type="text" id="joinCodeInput" placeholder="4-digit code">
         <button id="joinRoomBtn"></button>
      </div>
      <div id="room-info" style="display:none;">
          <p id="roomInfoText"></p>
          <div id="room-code-display"></div>
      </div>
      <hr>
      <button id="switchToJoinBtn"></button>
      <button id="switchToCreateBtn" style="display:none;"></button>
      <button id="closeModalBtn"></button>
    </div>
  </div>

  <script>
    const LANGS = [
      {
        code: "zh", name: "中文", title: "像素预览", originalTitle: "原始图像 (可拖动)",
        imgLabel: "上传图片", videoLabel: "上传视频", scaleLabel: "缩放", gridLabel: "网格",
        playBtn: "播放", pauseBtn: "暂停", tip: "上传媒体以查看像素化效果。",
        inviteBtn: "邀请好友", modalTitle: "协作模式", createRoomBtn: "创建房间",
        joinCodePlaceholder: "4位邀请码", joinRoomBtn: "加入房间", roomInfoText: "分享此邀请码给好友:",
        switchToJoinBtn: "已有邀请码?", switchToCreateBtn: "返回创建", closeModalBtn: "关闭",
        roomCreated: "房间已创建!", userJoined: "一位朋友已加入", userLeft: "一位朋友已离开",
        collabStatus: "协作中", collabUnavailable: "协作功能不可用",
        shapeLabel: "像素形状", radiusLabel: "圆角", pixelSizeLabel: "像素大小", shapeSquare: "直角方格", shapeRound: "圆角方格"
      },
      {
        code: "en", name: "English", title: "Pixel Preview", originalTitle: "Original Image (Draggable)",
        imgLabel: "Upload Image", videoLabel: "Upload Video", scaleLabel: "Scale", gridLabel: "Grid",
        playBtn: "Play", pauseBtn: "Pause", tip: "Upload media to see the pixelated effect.",
        inviteBtn: "Invite Friend", modalTitle: "Collaboration Mode", createRoomBtn: "Create Room",
        joinCodePlaceholder: "4-digit code", joinRoomBtn: "Join Room", roomInfoText: "Share this code with your friend:",
        switchToJoinBtn: "Have a code?", switchToCreateBtn: "Back to Create", closeModalBtn: "Close",
        roomCreated: "Room Created!", userJoined: "A friend has joined", userLeft: "A friend has left",
        collabStatus: "In collaboration", collabUnavailable: "Collaboration unavailable",
        shapeLabel: "Pixel Shape", radiusLabel: "Radius", pixelSizeLabel: "Pixel Size", shapeSquare: "Square", shapeRound: "Round"
      },
      {
        code: "no", name: "Norsk", title: "Piksel Forhåndsvisning", originalTitle: "Originalbilde (Dra-bart)",
        imgLabel: "Last opp bilde", videoLabel: "Last opp video", scaleLabel: "Skala", gridLabel: "Rutenett",
        playBtn: "Spill av", pauseBtn: "Pause", tip: "Last opp media for å se den pikselerte effekten.",
        inviteBtn: "Inviter venner", modalTitle: "Samarbeidsmodus", createRoomBtn: "Opprett rom",
        joinCodePlaceholder: "4-sifret kode", joinRoomBtn: "Join Room", roomInfoText: "Del denne koden med en venn:",
        switchToJoinBtn: "Har du en kode?", switchToCreateBtn: "Tilbake til Opprett", closeModalBtn: "Lukk",
        roomCreated: "Rom opprettet!", userJoined: "En venn har joindt", userLeft: "En venn har forlatt",
        collabStatus: "I samarbeid", collabUnavailable: "Samarbeid utilgjengelig",
        shapeLabel: "Pikselform", radiusLabel: "Radius", pixelSizeLabel: "Pikselstørrelse", shapeSquare: "Rektangel", shapeRound: "Sirkel"
      },
      {
        code: "ko", name: "한국어", title: "픽셀 미리보기", originalTitle: "원본 이미지 (드래그 가능)",
        imgLabel: "이미지 업로드", videoLabel: "비디오 업로드", scaleLabel: "확대/축소", gridLabel: "그리드",
        playBtn: "재생", pauseBtn: "일시정지", tip: "픽셀화 효과를 보려면 미디어를 업로드하십시오.",
        inviteBtn: "친구 초대", modalTitle: "협업 모드", createRoomBtn: "방 만들기",
        joinCodePlaceholder: "4자 초대코드", joinRoomBtn: "방 참여", roomInfoText: "이 초대코드를 친구에게 공유하세요:",
        switchToJoinBtn: "초대코드가 있습니까?", switchToCreateBtn: "만들기로 돌아가기", closeModalBtn: "닫기",
        roomCreated: "방이 만들어졌습니다!", userJoined: "친구가 참여했습니다", userLeft: "친구가 떠났습니다",
        collabStatus: "협업 중", collabUnavailable: "협업 기능을 사용할 수 없습니다",
        shapeLabel: "픽셀 모양", radiusLabel: "반지름", pixelSizeLabel: "픽셀 크기", shapeSquare: "직각 사각형", shapeRound: "둥근 사각형"
      }
    ];
    
    const pixelCanvas = document.getElementById('pixelCanvas');
    const pCtx = pixelCanvas.getContext('2d');
    const originalCanvas = document.getElementById('originalCanvas');
    const oCtx = originalCanvas.getContext('2d');
    const video = document.getElementById('video');
    const errorMsg = document.getElementById('errorMsg');

    let langIdx = 0, gridSize = 8, cellSize = pixelCanvas.width / gridSize, pixelShape = 'round', cellRadius = 13, pixelSizeRatio = 1;
    
    let img = null, isVideo = false, mediaSrc = null;
    let imgObj = { x: 0, y: 0, scale: 1 };
    let isDragging = false, startX, startY;
    let animationId = null;
    let mediaJustLoaded = false;
    
    function setLangByCode(code) {
      langIdx = LANGS.findIndex(l => l.code === code);
      if (langIdx === -1) langIdx = 0;
      const L = LANGS[langIdx];
      document.getElementById('title').textContent = L.title;
      document.getElementById('originalTitle').textContent = L.originalTitle;
      document.getElementById('imgLabel').childNodes[0].textContent = L.imgLabel;
      document.getElementById('videoLabel').childNodes[0].textContent = L.videoLabel;
      document.getElementById('scaleLabel').textContent = L.scaleLabel;
      document.getElementById('gridLabel').textContent = L.gridLabel;
      document.getElementById('playBtn').textContent = L.playBtn;
      document.getElementById('pauseBtn').textContent = L.pauseBtn;
      document.getElementById('tip').textContent = L.tip;
      document.getElementById('inviteBtn').textContent = L.inviteBtn;
      document.getElementById('modalTitle').textContent = L.modalTitle;
      document.getElementById('createRoomBtn').textContent = L.createRoomBtn;
      document.getElementById('joinCodeInput').placeholder = L.joinCodePlaceholder;
      document.getElementById('joinRoomBtn').textContent = L.joinRoomBtn;
      document.getElementById('roomInfoText').textContent = L.roomInfoText;
      document.getElementById('switchToJoinBtn').textContent = L.switchToJoinBtn;
      document.getElementById('switchToCreateBtn').textContent = L.switchToCreateBtn;
      document.getElementById('closeModalBtn').textContent = L.closeModalBtn;
      document.getElementById('shapeLabel').textContent = L.shapeLabel || '像素形状';
      document.getElementById('radiusLabel').textContent = L.radiusLabel || '圆角';
      document.getElementById('pixelSizeLabel').textContent = L.pixelSizeLabel || '像素大小';
      document.querySelector('#shapeSelect option[value="square"]').textContent = L.shapeSquare || '直角方格';
      document.querySelector('#shapeSelect option[value="round"]').textContent = L.shapeRound || '圆角方格';
      errorMsg.textContent = '';
    }

    function updateControlsVisibility() {
      const hasMedia = img || isVideo;
      document.getElementById('mediaControls').style.display = hasMedia ? 'flex' : 'none';
      document.getElementById('videoControls').style.display = isVideo ? 'flex' : 'none';
      document.getElementById('originalCanvasWrapper').style.display = hasMedia ? 'block' : 'none';
    }

    function renderCanvases() {
      // Clear canvases
      pCtx.fillStyle = "#111";
      pCtx.fillRect(0, 0, pixelCanvas.width, pixelCanvas.height);
      oCtx.fillStyle = "#111";
      oCtx.fillRect(0, 0, originalCanvas.width, originalCanvas.height);

      let source = img || (isVideo ? video : null);
      if (source) {
        const sourceW = isVideo ? video.videoWidth : img.width;
        const sourceH = isVideo ? video.videoHeight : img.height;
        oCtx.drawImage(source, imgObj.x, imgObj.y, sourceW * imgObj.scale, sourceH * imgObj.scale);
        // --- Draw Pixelated Canvas (320x320) ---
        const sx = -imgObj.x / imgObj.scale;
        const sy = -imgObj.y / imgObj.scale;
        const sWidth = pixelCanvas.width / imgObj.scale;
        const sHeight = pixelCanvas.height / imgObj.scale;
        const avgColorCanvas = document.createElement('canvas');
        avgColorCanvas.width = gridSize;
        avgColorCanvas.height = gridSize;
        const avgColorCtx = avgColorCanvas.getContext('2d');
        avgColorCtx.drawImage(source, sx, sy, sWidth, sHeight, 0, 0, gridSize, gridSize);
        const gap = 2; // 格子间距
        let radius = pixelShape === 'round' ? cellRadius : 0;
        for (let y = 0; y < gridSize; y++) {
          for (let x = 0; x < gridSize; x++) {
            const pixel = avgColorCtx.getImageData(x, y, 1, 1).data;
            const color = `rgba(${pixel[0]},${pixel[1]},${pixel[2]},${pixel[3]/255})`;
            const px = x * cellSize + (cellSize - cellSize * pixelSizeRatio) / 2 + gap/2;
            const py = y * cellSize + (cellSize - cellSize * pixelSizeRatio) / 2 + gap/2;
            const size = cellSize * pixelSizeRatio - gap;
            pCtx.fillStyle = color;
            fillRoundRect(pCtx, px, py, size, size, radius);
          }
        }
      }
      // Draw grid lines on pixel canvas
      pCtx.save();
      pCtx.strokeStyle = "rgba(128, 128, 128, 0.3)";
      pCtx.lineWidth = 1;
      for(let i = 1; i < gridSize; i++){
          pCtx.beginPath();
          pCtx.moveTo(i * cellSize, 0);
          pCtx.lineTo(i * cellSize, pixelCanvas.height);
          pCtx.stroke();
          pCtx.beginPath();
          pCtx.moveTo(0, i * cellSize);
          pCtx.lineTo(pixelCanvas.width, i * cellSize);
          pCtx.stroke();
      }
      pCtx.restore();
    }

    function getPointer(e, targetCanvas) {
      const rect = targetCanvas.getBoundingClientRect();
      const touch = e.touches ? e.touches[0] : e;
      return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
    }

    function handlePointerDown(e) {
        if (img || isVideo) {
            isDragging = true;
            const pointer = getPointer(e, originalCanvas);
            startX = pointer.x - imgObj.x;
            startY = pointer.y - imgObj.y;
        }
    }

    function handlePointerMove(e) {
        if (isDragging) {
            const pointer = getPointer(e, originalCanvas);
            imgObj.x = pointer.x - startX;
            imgObj.y = pointer.y - startY;
            renderCanvases();
        }
    }

    function handlePointerUp() {
      isDragging = false;
    }
    
    document.getElementById('langSelect').onchange = (e) => setLangByCode(e.target.value);
    
    document.getElementById('gridSizeSelect').onchange = (e) => {
        gridSize = parseInt(e.target.value, 10);
        cellSize = pixelCanvas.width / gridSize;
        renderCanvases();
    };
    
    document.getElementById('shapeSelect').onchange = (e) => {
        pixelShape = e.target.value;
        document.getElementById('radiusSlider').disabled = (pixelShape === 'square');
        renderCanvases();
    };
    
    document.getElementById('radiusSlider').oninput = function() {
        cellRadius = parseInt(this.value, 10);
        document.getElementById('radiusVal').textContent = cellRadius;
        renderCanvases();
    };
    
    document.getElementById('scaleSlider').oninput = function() {
       if (!img && !isVideo) return;
       const oldScale = imgObj.scale;
       const newScale = parseFloat(this.value);
       document.getElementById('scaleVal').textContent = newScale.toFixed(2);
       
       const canvasCenterX = originalCanvas.width / 2;
       const canvasCenterY = originalCanvas.height / 2;
       
       const centerRelX = canvasCenterX - imgObj.x;
       const centerRelY = canvasCenterY - imgObj.y;
       const imgPointX = centerRelX / oldScale;
       const imgPointY = centerRelY / oldScale;
       
       imgObj.x = canvasCenterX - imgPointX * newScale;
       imgObj.y = canvasCenterY - imgPointY * newScale;
       imgObj.scale = newScale;
       renderCanvases();
    };
    
    document.getElementById('pixelSizeSlider').oninput = function() {
        pixelSizeRatio = parseFloat(this.value);
        document.getElementById('pixelSizeVal').textContent = pixelSizeRatio.toFixed(2);
        renderCanvases();
    };
    
    function setupMedia(file) {
      mediaSrc = URL.createObjectURL(file);
      updateControlsVisibility();
      mediaJustLoaded = true;
      const L = LANGS[langIdx];
      const tip = document.getElementById('tip');
      tip.textContent = `Loading ${file.name}...`;
      return mediaSrc;
    }
    
    function loadMediaFromURL(src, isVideoSrc) {
        mediaSrc = src;
        isVideo = isVideoSrc;
        if (isVideo) {
            img = null;
            video.src = src;
        } else {
            video.pause();
            img = new Image();
            img.src = src;
        }
    }

    document.getElementById('imgInput').onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      isVideo = false;
      img = new Image();
      const imgUrl = setupMedia(file);
      
      img.onload = () => {
        if (mediaJustLoaded) {
            imgObj.scale = 1;
            document.getElementById('scaleSlider').value = 1;
            document.getElementById('scaleVal').textContent = "1.00";
            imgObj.x = (originalCanvas.width - img.width) / 2;
            imgObj.y = (originalCanvas.height - img.height) / 2;
            mediaJustLoaded = false;
        }
        document.getElementById('tip').textContent = `Successfully loaded ${file.name}.`;
        renderCanvases();
      }
      img.onerror = () => {
        document.getElementById('tip').textContent = `Error loading ${file.name}. The file may be corrupt or an unsupported format.`;
      };
      img.src = imgUrl;
      
      video.pause();
      cancelAnimationFrame(animationId);
    };

    document.getElementById('videoInput').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        isVideo = true;
        img = null;
        const videoUrl = setupMedia(file);

        video.oncanplay = () => {
          if (mediaJustLoaded) {
            imgObj.scale = 1;
            document.getElementById('scaleSlider').value = 1;
            document.getElementById('scaleVal').textContent = "1.00";
            imgObj.x = (originalCanvas.width - video.videoWidth) / 2;
            imgObj.y = (originalCanvas.height - video.videoHeight) / 2;
            mediaJustLoaded = false;
            document.getElementById('tip').textContent = `Successfully loaded ${file.name}.`;
          }
          renderCanvases();
        };
        video.onerror = () => {
            document.getElementById('tip').textContent = `Error loading ${file.name}. The file may be corrupt or an unsupported format.`;
        };
        video.src = videoUrl;
    };
    
    document.getElementById('playBtn').onclick = () => video.play();
    document.getElementById('pauseBtn').onclick = () => video.pause();
    
    function videoLoop() {
        if (!isVideo || video.paused || video.ended) {
            cancelAnimationFrame(animationId);
            return;
        }
        renderCanvases();
        animationId = requestAnimationFrame(videoLoop);
    }
    
    // Event Listeners
    originalCanvas.addEventListener('mousedown', handlePointerDown);
    originalCanvas.addEventListener('mousemove', handlePointerMove);
    originalCanvas.addEventListener('mouseup', handlePointerUp);
    originalCanvas.addEventListener('mouseleave', handlePointerUp);
    originalCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); handlePointerDown(e); }, { passive: false });
    originalCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); handlePointerMove(e); }, { passive: false });
    originalCanvas.addEventListener('touchend', handlePointerUp);

    video.addEventListener('play', () => {
        cancelAnimationFrame(animationId); // Ensure no previous loops are running
        animationId = requestAnimationFrame(videoLoop);
    });
    video.addEventListener('pause', () => cancelAnimationFrame(animationId));
    video.addEventListener('ended', () => {
        video.currentTime = 0;
        video.play();
        cancelAnimationFrame(animationId);
    });
    video.addEventListener('seeked', renderCanvases);
    
    // Modal Logic
    const collabModal = document.getElementById('collabModal');
    const inviteBtn = document.getElementById('inviteBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const joinCodeInput = document.getElementById('joinCodeInput');
    const switchToJoinBtn = document.getElementById('switchToJoinBtn');
    const switchToCreateBtn = document.getElementById('switchToCreateBtn');
    const createRoomView = document.getElementById('create-room-view');
    const joinRoomView = document.getElementById('join-room-view');

    inviteBtn.addEventListener('click', () => collabModal.style.display = 'flex');
    closeModalBtn.addEventListener('click', () => collabModal.style.display = 'none');
    switchToJoinBtn.addEventListener('click', () => {
      createRoomView.style.display = 'none';
      switchToJoinBtn.style.display = 'none';
      joinRoomView.style.display = 'block';
      switchToCreateBtn.style.display = 'inline-block';
    });
    switchToCreateBtn.addEventListener('click', () => {
      createRoomView.style.display = 'block';
      switchToJoinBtn.style.display = 'inline-block';
      joinRoomView.style.display = 'none';
      switchToCreateBtn.style.display = 'none';
    });

    createRoomBtn.addEventListener('click', () => {
        // Implementation of creating a room
    });

    joinRoomBtn.addEventListener('click', () => {
        const code = joinCodeInput.value;
        if (code) {
            // Implementation of joining a room
        }
    });
    
    // Initialization
    setLangByCode('zh');
    cellSize = pixelCanvas.width / gridSize;
    document.getElementById('radiusSlider').value = cellRadius;
    document.getElementById('radiusVal').textContent = cellRadius;
    document.getElementById('shapeSelect').value = pixelShape;
    document.getElementById('radiusSlider').disabled = (pixelShape === 'square');
    document.getElementById('pixelSizeSlider').value = pixelSizeRatio;
    document.getElementById('pixelSizeVal').textContent = pixelSizeRatio.toFixed(2);
    updateControlsVisibility();
    renderCanvases();

    // 在 renderCanvases 外部加上 fillRoundRect 辅助函数
    function fillRoundRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
      ctx.fill();
    }
  </script>
</body>
</html> 
